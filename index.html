<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top-Down RPG Multiplayer</title>
<style>
body { margin:0; overflow:hidden; background:#1a1a1a; font-family:sans-serif; color:white;}
canvas { display:block; }
#chat {
  position:absolute; bottom:10px; left:10px; width:300px;
  max-height:200px; overflow-y:auto; background: rgba(0,0,0,0.6); padding:5px; border-radius:5px;
}
#chat input {
  width:100%; box-sizing:border-box; border:none; padding:5px; border-radius:3px;
}
.message { margin:2px 0; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Type a message and press Enter">
</div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
// === Canvas Setup ===
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// === Player Controls ===
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// === World & Obstacles ===
const world = { width:2000, height:2000 };
const obstacles = [
  {x:600, y:400, w:200, h:50},
  {x:1200, y:800, w:100, h:300},
  {x:900, y:1500, w:300, h:50}
];

// === GUN.js Multiplayer ===
const gun = Gun();
const playersRef = gun.get('players');
const chatRef = gun.get('chat');

const localId = Math.random().toString(36).substr(2,9);
const localName = prompt("Enter your name") || "Player"+localId.slice(0,4);
const localPlayer = { x:400, y:300, color: "#"+Math.floor(Math.random()*16777215).toString(16), size:30, health:100, attack:false, name:localName, score:0 };
playersRef.get(localId).put(localPlayer);

const players = {};
players[localId] = localPlayer;

// === Chat System ===
const chatInput = document.getElementById("chatInput");
const messagesDiv = document.getElementById("messages");

chatInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && chatInput.value.trim()!==""){
    chatRef.set({id:localId,msg:chatInput.value,name:localPlayer.name});
    chatInput.value="";
  }
});

chatRef.map().on(data=>{
  if(!data) return;
  const div = document.createElement("div");
  div.className="message";
  div.textContent=`${data.name || "Player"}: ${data.msg}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Listen for all player updates
playersRef.map().on((data,id)=>{
  if(!data) return;
  players[id] = data;
});

// === Game Loop ===
function update(){
  let nextX = localPlayer.x;
  let nextY = localPlayer.y;

  if(keys["w"]) nextY -= 3;
  if(keys["s"]) nextY += 3;
  if(keys["a"]) nextX -= 3;
  if(keys["d"]) nextX += 3;

  // Collision check
  for(const obs of obstacles){
    if(nextX + localPlayer.size/2 > obs.x && nextX - localPlayer.size/2 < obs.x + obs.w &&
       nextY + localPlayer.size/2 > obs.y && nextY - localPlayer.size/2 < obs.y + obs.h){
      nextX = localPlayer.x;
      nextY = localPlayer.y;
      break;
    }
  }

  localPlayer.x = nextX;
  localPlayer.y = nextY;
  playersRef.get(localId).put(localPlayer);
}

function draw(){
  const camX = localPlayer.x - canvas.width/2;
  const camY = localPlayer.y - canvas.height/2;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Grid
  ctx.fillStyle="#2e2e2e";
  for(let x=0;x<world.width;x+=100){
    for(let y=0;y<world.height;y+=100){
      ctx.fillRect(x-camX,y-camY,90,90);
    }
  }

  // Obstacles
  ctx.fillStyle="#555555";
  for(const obs of obstacles){
    ctx.fillRect(obs.x-camX, obs.y-camY, obs.w, obs.h);
  }

  // Draw players
  for(const id in players){
    const p = players[id];
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x - p.size/2 - camX, p.y - p.size/2 - camY, p.size, p.size);

    // Health bar
    ctx.fillStyle="red";
    ctx.fillRect(p.x-15-camX, p.y-p.size/2-10-camY, 30*(p.health/100),5);
    ctx.strokeStyle="black";
    ctx.strokeRect(p.x-15-camX, p.y-p.size/2-10-camY,30,5);

    // Name & score
    ctx.fillStyle="white";
    ctx.font="12px sans-serif";
    ctx.fillText(`${p.name} (Score: ${p.score})`, p.x-15-camX, p.y-p.size/2-15-camY);
  }
}

function gameLoop(){
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
