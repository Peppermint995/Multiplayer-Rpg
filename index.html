<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top-Down RPG Multiplayer (GUN.js)</title>
<style>
  body { margin:0; overflow:hidden; background:#1a1a1a; font-family:sans-serif; color:white;}
  canvas { display:block; background:#3a3a3a; }
  #chat {
    position: absolute; bottom:10px; left:10px; width:300px;
    max-height:200px; overflow-y:auto; background: rgba(0,0,0,0.6); padding:5px; border-radius:5px;
  }
  #chat input {
    width:100%; box-sizing:border-box; border:none; padding:5px; border-radius:3px;
  }
  .message { margin:2px 0; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Type a message and press Enter">
</div>

<!-- Include GUN.js -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

const world = { width: 2000, height: 2000 };
const speed = 3;

// Setup GUN
const gun = Gun();
const playersRef = gun.get('players');
const chatRef = gun.get('chat');

// Local player
const localId = Math.random().toString(36).substr(2, 9);
const localPlayer = { x: 400, y: 300, color: "#"+Math.floor(Math.random()*16777215).toString(16), size:30 };
playersRef.get(localId).put(localPlayer);

// All players
const players = {};
players[localId] = localPlayer;

// Listen for other players
playersRef.map().on((data, id) => {
  if(id !== localId && data){
    players[id] = data;
  }
});

// Remove players when they disconnect (approximation using empty object)
playersRef.map().on((data, id) => {
  if(data === null){ delete players[id]; }
});

// Chat
const chatInput = document.getElementById("chatInput");
const messagesDiv = document.getElementById("messages");

chatInput.addEventListener("keydown", e => {
  if(e.key === "Enter" && chatInput.value.trim() !== ""){
    chatRef.set({ id: localId, msg: chatInput.value });
    chatInput.value = "";
  }
});

chatRef.map().on((data) => {
  if(!data) return;
  const div = document.createElement("div");
  div.className = "message";
  div.textContent = `Player ${data.id.slice(0,4)}: ${data.msg}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Update local player position in GUN
function updatePosition(){
  localPlayer.x = Math.max(0, Math.min(world.width, localPlayer.x));
  localPlayer.y = Math.max(0, Math.min(world.height, localPlayer.y));
  playersRef.get(localId).put(localPlayer);
}

// Game loop
function update(){
  if(keys["w"]) localPlayer.y -= speed;
  if(keys["s"]) localPlayer.y += speed;
  if(keys["a"]) localPlayer.x -= speed;
  if(keys["d"]) localPlayer.x += speed;

  updatePosition();
}

function draw(){
  const camX = localPlayer.x - canvas.width/2;
  const camY = localPlayer.y - canvas.height/2;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw grid
  ctx.fillStyle="#2e2e2e";
  for(let x=0;x<world.width;x+=100){
    for(let y=0;y<world.height;y+=100){
      ctx.fillRect(x-camX,y-camY,90,90);
    }
  }

  // Draw all players
  for(const id in players){
    const p = players[id];
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x - p.size/2 - camX, p.y - p.size/2 - camY, p.size, p.size);
  }
}

function gameLoop(){
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
